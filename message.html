<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Message Viewer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="style.css">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
</head>
<body>
  <div id="starfield"></div>
  <div class="container">
    <div class="card glass-card">
      <div class="flex items-start justify-between">
        <div style="display:flex;gap:12px;align-items:center;">
          <div id="iconBadge" class="iconBadge" aria-hidden="true"></div>
          <div>
            <div class="title" id="title">Message</div>
            <div class="muted mt-1" id="subtitle">A private message will be shown when the countdown finishes</div>
          </div>
        </div>
        <div class="text-right">
            <div id="sectionLabel" class="section-label">&nbsp;</div>
            <div style="display:flex;gap:.5rem;align-items:center;justify-content:flex-end;">
              <div class="muted mt-1 text-sm">48-hour access window after countdown</div>
              <div id="audioControls" style="display:flex;gap:.4rem;align-items:center;margin-left:8px">
                <button id="playBtn" class="btn" aria-label="Play music" style="min-width:36px;padding:.25rem .5rem">Play</button>
                <button id="muteBtn" class="btn" aria-label="Mute music" style="min-width:36px;padding:.25rem .5rem">Mute</button>
              </div>
            </div>
        </div>
      </div>

      <div id="statusWrap" class="mt-4">
        <!-- notice or timer shown here -->
      </div>

      <div id="messageArea" class="message-body mt-4">
        <div class="placeholder">Loading…</div>
      </div>

      <div class="meta">
        <div style="margin-left:auto;display:flex;gap:.5rem">
          <a id="adminLink" href="index.html" class="btn" style="background:transparent;border:1px solid rgba(255,255,255,0.06);">Admin</a>
          <a id="countdownLink" href="countdown.html" class="btn" style="background:linear-gradient(90deg,#86efac,#93c5fd);color:#000">Back to Countdown</a>
        </div>
      </div>
        <!-- audio sources for each section (looped) -->
        <audio id="audio_nist" src="assets/nist.mp3" preload="auto" loop></audio>
        <audio id="audio_bqt" src="assets/bqt.mp3" preload="auto" loop></audio>
        <audio id="audio_nqt" src="assets/nqt.mp3" preload="auto" loop></audio>
    </div>
  </div>

  <script>
    // Helper to read query param
    function qs(name){ return new URLSearchParams(location.search).get(name); }
    const section = qs('section') || 'ist';
    const titleMap = { 'ist':'India — IST', 'qatar':'Qatar — AST', 'qatar-birth':'Exact Birth Moment'};
    // No verbose descriptors: visual themes will represent context.
    const descriptorMap = { 'ist':'', 'qatar':'', 'qatar-birth':'' };
    const iconSvg = {
      'ist': '<svg width="44" height="44" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">\n  <rect width="48" height="48" rx="8" fill="#081021"/>\n  <rect x="4" y="8" width="40" height="8" fill="#FF9933" rx="3"/>\n  <rect x="4" y="18" width="40" height="6" fill="#FFFFFF" rx="3"/>\n  <rect x="4" y="26" width="40" height="6" fill="#138808" rx="3"/>\n  <g transform="translate(24,23)">\n    <circle cx="0" cy="0" r="5.2" fill="#0b3d91"/>\n    <circle cx="0" cy="0" r="4.2" fill="#fff"/>\n    <g stroke="#0b3d91" stroke-width="0.8">\n      <line x1="0" y1="-3.8" x2="0" y2="-5.2" transform="rotate(0)" />\n      <line x1="0" y1="-3.8" x2="0" y2="-5.2" transform="rotate(15)" />\n      <line x1="0" y1="-3.8" x2="0" y2="-5.2" transform="rotate(30)" />\n      <line x1="0" y1="-3.8" x2="0" y2="-5.2" transform="rotate(45)" />\n      <line x1="0" y1="-3.8" x2="0" y2="-5.2" transform="rotate(60)" />\n      <line x1="0" y1="-3.8" x2="0" y2="-5.2" transform="rotate(75)" />\n      <line x1="0" y1="-3.8" x2="0" y2="-5.2" transform="rotate(90)" />\n      <line x1="0" y1="-3.8" x2="0" y2="-5.2" transform="rotate(105)" />\n      <line x1="0" y1="-3.8" x2="0" y2="-5.2" transform="rotate(120)" />\n      <line x1="0" y1="-3.8" x2="0" y2="-5.2" transform="rotate(135)" />\n      <line x1="0" y1="-3.8" x2="0" y2="-5.2" transform="rotate(150)" />\n      <line x1="0" y1="-3.8" x2="0" y2="-5.2" transform="rotate(165)" />\n      <line x1="0" y1="-3.8" x2="0" y2="-5.2" transform="rotate(180)" />\n      <line x1="0" y1="-3.8" x2="0" y2="-5.2" transform="rotate(195)" />\n      <line x1="0" y1="-3.8" x2="0" y2="-5.2" transform="rotate(210)" />\n      <line x1="0" y1="-3.8" x2="0" y2="-5.2" transform="rotate(225)" />\n      <line x1="0" y1="-3.8" x2="0" y2="-5.2" transform="rotate(240)" />\n      <line x1="0" y1="-3.8" x2="0" y2="-5.2" transform="rotate(255)" />\n      <line x1="0" y1="-3.8" x2="0" y2="-5.2" transform="rotate(270)" />\n      <line x1="0" y1="-3.8" x2="0" y2="-5.2" transform="rotate(285)" />\n      <line x1="0" y1="-3.8" x2="0" y2="-5.2" transform="rotate(300)" />\n      <line x1="0" y1="-3.8" x2="0" y2="-5.2" transform="rotate(315)" />\n      <line x1="0" y1="-3.8" x2="0" y2="-5.2" transform="rotate(330)" />\n      <line x1="0" y1="-3.8" x2="0" y2="-5.2" transform="rotate(345)" />\n    </g>\n  </g>\n</svg>',
      'qatar': '<svg width="44" height="44" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">\n  <rect width="48" height="48" rx="8" fill="#8a1538"/>\n  <path d="M4 10 L22 10 L18 14 L22 18 L18 22 L22 26 L18 30 L22 34 L4 34 Z" fill="#ffffff"/>\n</svg>',
      'qatar-birth': '<svg width="44" height="44" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">\n  <rect width="48" height="48" rx="8" fill="#040614"/>\n  <g transform="translate(24,22)">\n    <path class="icon-moon" d="M8,-4 A9 9 0 1 1 -6,12 A6 6 0 0 0 8,-4" fill="#ffd166"/>\n    <circle class="icon-star" cx="-6" cy="-8" r="1.8" fill="#ffffff" />\n    <circle class="icon-star" cx="6" cy="-10" r="1.2" fill="#ffffff" />\n    <circle class="icon-star" cx="10" cy="-2" r="1.4" fill="#ffffff" />\n  </g>\n</svg>'
    };

    // Time to display for birth moment
    const timeMap = { 'qatar-birth': '11:50 PM (AST)' };
    const sectionLabel = document.getElementById('sectionLabel');
    const titleEl = document.getElementById('title');
    const iconEl = document.getElementById('iconBadge');
    // keep top title neutral and use the message header inside the body as the section label
    titleEl.textContent = 'Message Viewer';
    sectionLabel.textContent = '';
    iconEl.innerHTML = '';
    // neutral subtitle (avoid textual explanation)
    document.getElementById('subtitle').textContent = '';
    // apply visual theme to the main card and hide top badge/label
    const cardEl = document.querySelector('.card');
    if (cardEl) {
      cardEl.classList.remove('theme-ist','theme-qatar','theme-birth','hide-top-header');
      if (section === 'ist') cardEl.classList.add('theme-ist','hide-top-header');
      else if (section === 'qatar') cardEl.classList.add('theme-qatar','hide-top-header');
      else if (section === 'qatar-birth') cardEl.classList.add('theme-birth','hide-top-header');
    }

    const lastHitKey = section==='qatar-birth' ? 'lastHit_qatar_birth' : (section==='qatar' ? 'lastHit_qatar' : 'lastHit_ist');
    const messageKey = 'message_' + section;
    const HOURS48 = 48*60*60*1000;

    const statusWrap = document.getElementById('statusWrap');
    const messageArea = document.getElementById('messageArea');
    // audio elements mapping
    const audioMap = {
      'ist': document.getElementById('audio_nist'),
      'qatar': document.getElementById('audio_bqt'),
      'qatar-birth': document.getElementById('audio_nqt')
    };
    const playBtn = document.getElementById('playBtn');
    const muteBtn = document.getElementById('muteBtn');
    let currentAudio = null;
    let isMuted = localStorage.getItem('music_muted') === '1';
    // initialize buttons
    function updateMuteButton(){ muteBtn.textContent = isMuted ? 'Unmute' : 'Mute'; }
    updateMuteButton();
    function stopAllAudio(){ Object.values(audioMap).forEach(a=>{ try{ if(a && !a.paused) a.pause(); a.currentTime = 0; }catch(e){} }); currentAudio = null; }
    function tryPlayAudio(a){ if(!a) return Promise.reject(); a.muted = isMuted; return a.play(); }
    playBtn.addEventListener('click', ()=>{
      if (currentAudio && !currentAudio.paused) { currentAudio.pause(); playBtn.textContent = 'Play'; return; }
      if (!currentAudio) return; tryPlayAudio(currentAudio).then(()=>{ playBtn.textContent = 'Pause'; }).catch(()=>{ playBtn.textContent = 'Play'; });
    });
    muteBtn.addEventListener('click', ()=>{ isMuted = !isMuted; localStorage.setItem('music_muted', isMuted ? '1' : '0'); if(currentAudio) currentAudio.muted = isMuted; updateMuteButton(); });

    function renderWaiting() {
      statusWrap.innerHTML = '<div class="notice" style="background:linear-gradient(90deg,#60a5fa,#a78bfa)">Please wait — once the countdown reaches its target, the message will be accessible for 48 hours.</div>';
      messageArea.innerHTML = '<div class="placeholder">Message will appear here when the countdown finishes.</div>';
    }

    function renderNoMessage() {
      statusWrap.innerHTML = '<div class="notice" style="background:#ef4444">No message set</div>';
      messageArea.innerHTML = '<div class="placeholder">No message has been set by admin yet. Open <strong>Admin</strong> to add one.</div>';
    }

    function renderExpired() {
      statusWrap.innerHTML = '<div class="notice" style="background:linear-gradient(90deg,#f97316,#fca5a5)">Message window expired</div>';
      messageArea.innerHTML = '<div class="placeholder">This message was available for 48 hours after the countdown finished. Please wait until the next countdown.</div>';
    }

    function renderAvailable(messageHtml, remainingMs) {
      statusWrap.innerHTML = '<div style="display:flex;gap:12px;align-items:center"><div class="notice" style="background:linear-gradient(90deg,#fde68a,#fbcfe8);">Available</div><div class="timer" id="timerEl">'+formatDuration(remainingMs)+'</div></div>';
      // prepend a small contextual header to the message
      const header = document.createElement('div');
      header.className = 'contextHeader';
      const iconWrap = document.createElement('div');
      iconWrap.className = 'contextIconWrap';
      iconWrap.innerHTML = iconSvg[section] || '';
      // apply pulsing speed per theme for more expressive glow
      if (section === 'ist') iconWrap.classList.add('pulse','fast');
      else if (section === 'qatar') iconWrap.classList.add('pulse','slow');
      else if (section === 'qatar-birth') iconWrap.classList.add('pulse','fast');
      // accessibility: mark icon wrapper as an image with a descriptive label
      try { iconWrap.setAttribute('role','img'); iconWrap.setAttribute('aria-label', titleMap[section] || 'message icon'); } catch(e){}
      // no serration element — Qatar uses the same card layout as IST with a top stripe
      const txt = document.createElement('div');
      // include time for birth moment
      const titleHtml = '<div class="contextTitle">'+(titleMap[section]||'Message')+'</div>';
      const subText = (section === 'qatar-birth') ? (timeMap['qatar-birth']) : (descriptorMap[section]||'');
      txt.innerHTML = titleHtml + '<div class="contextSubtitle">'+subText+'</div>';
      header.appendChild(iconWrap);
      header.appendChild(txt);
      // clear messageArea and append header + content
      messageArea.innerHTML = '';
      messageArea.appendChild(header);
      const body = document.createElement('div');
      body.className = 'bodyContent';
      // if admin stored raw HTML without our wrapper, wrap it with .content-inner for consistent styling
      if (messageHtml && /class="content-inner"/.test(messageHtml) === false) {
        body.innerHTML = '<div class="content-inner">' + (messageHtml || '') + '</div>';
      } else {
        body.innerHTML = messageHtml || '<div class="placeholder">(empty message)</div>';
      }
      messageArea.appendChild(body);
      // audio: choose track for this section
      try { stopAllAudio(); currentAudio = audioMap[section] || null; if(currentAudio){ currentAudio.muted = isMuted; tryPlayAudio(currentAudio).then(()=>{ playBtn.textContent = 'Pause'; }).catch(()=>{ /* autoplay blocked; show Play button */ playBtn.textContent = 'Play'; }); } } catch(e){}
      // update timer every second
      if (window._messageTimer) clearInterval(window._messageTimer);
      let lastHitTimestamp = 0;
      // Load initial timestamp
      getLastHit(section).then(ts => {
        lastHitTimestamp = ts;
      });
      // Listen for real-time updates
      const unsubscribeHit = onHitUpdate(section, (ts) => {
        lastHitTimestamp = ts;
      });
      window._messageTimer = setInterval(()=>{
        const rem = HOURS48 - (Date.now() - lastHitTimestamp);
        const timerEl = document.getElementById('timerEl');
        if (!timerEl) return;
        if (rem <= 0) { 
          clearInterval(window._messageTimer); 
          if (unsubscribeHit) unsubscribeHit();
          renderExpired(); 
          return; 
        }
        timerEl.textContent = formatDuration(rem);
      }, 1000);
    }

    function formatDuration(ms){
      const s = Math.floor(ms/1000);
      const h = Math.floor(s/3600);
      const m = Math.floor((s%3600)/60);
      const ss = s%60;
      const parts = [];
      if (h) parts.push(h+'h');
      if (m) parts.push(m+'m');
      if (ss || parts.length===0) parts.push(ss+'s');
      return parts.join(' ');
    }

    // Initial render + state (using Firebase)
    (async function(){
      const now = Date.now();
      
      // Load message and hit timestamp from Firebase
      const [message, last] = await Promise.all([
        getMessage(section),
        getLastHit(section)
      ]);

      if (!message) { renderNoMessage(); return; }
      if (!last || now < last) { renderWaiting(); return; }
      const elapsed = now - last;
      if (elapsed > HOURS48) { renderExpired(); return; }
      renderAvailable(message, HOURS48 - elapsed);
      
      // Listen for real-time message updates
      onMessageUpdate(section, (newMessage) => {
        if (newMessage && last && now >= last) {
          const elapsed = now - last;
          if (elapsed <= HOURS48) {
            renderAvailable(newMessage, HOURS48 - elapsed);
          }
        } else if (!newMessage) {
          renderNoMessage();
        }
      });
    })();

  </script>
  <script>
    // Add starfield (responsive count) and a subtle cursor trail to match galaxy vibes
    (function createStarfield(){
      const sf = document.getElementById('starfield');
      if(!sf) return;
      function build(){
        sf.innerHTML = '';
        const area = window.innerWidth * window.innerHeight;
        const count = Math.max(40, Math.min(200, Math.floor(area / 35000)));
        for(let i=0;i<count;i++){
          const s = document.createElement('div');
          s.className = 'star';
          const size = (Math.random()*2) + 0.6;
          s.style.width = s.style.height = size + 'px';
          s.style.left = (Math.random()*100) + '%';
          s.style.top = (Math.random()*100) + '%';
          s.style.opacity = (0.25 + Math.random()*0.8).toString();
          s.style.transform = 'translate(-50%,-50%)';
          s.style.animationDelay = (Math.random()*4) + 's';
          sf.appendChild(s);
        }
      }
      build();
      let resizeTimer;
      window.addEventListener('resize', ()=>{ clearTimeout(resizeTimer); resizeTimer = setTimeout(build, 300); });
    })();

    // (cursor trail removed — starfield retained for galaxy background)
  </script>
</body>
</html>
